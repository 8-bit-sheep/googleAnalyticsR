---
title: "Data API for Google Analytics 4 (App+Web)"
---

The Data API and Google Analytics Admin API are used with the Google Analytics 4 properties, the newest version of Google Analytics and evolution from Universal Analytics.  

```{r include=FALSE}
library(googleAnalyticsR)
```


## Features

* Only API to fetch data from Google Analytics 4 properties
* No sampling
* Fewer limits on exports, such as being able to fetch more than 1million rows
* Ability to create your own custom metrics and dimensions
* Send in up to 4 date ranges at once
* Easier integration with the real-time API
* Improved filter syntax

## Meta data

Universal metadata for what you can query via the Data API can be found by specifying that API in the `ga_meta()` function:

```r
metadata <- ga_meta(version = "data")
```

You may have custom dimensions and metrics setup for your web property - to get a list of those specify the web property in the meta data call:

```r
# Google Analytics 4 metadata for a particular Web Property
ga_meta("data", propertyId = 206670707)
```

## Fetching data

Make sure to authenticate first using `ga_auth()` or otherwise.

The primary data fetching function is `ga_data()`

You need your propertyId to query data, and then at least a metric and date range:

```r
# replace with your propertyId
my_property_id <- 206670707
basic <- ga_data(
  my_property_id,
  metrics = c("activeUsers","sessions"),
  date_range = c("2020-03-31", "2020-04-27")
  )
```

Dimensions can be added to split out your results:

```r
# split out metrics by the dimensions specified
dimensions <- ga_data(
    my_property_id,
    metrics = c("activeUsers","sessions"),
    dimensions = c("date","city","dayOfWeek"),
    date_range = c("2020-03-31", "2020-04-27")
)
```

By default the API returns 100 results.  Add the `limit` parameter to change the number of results returned.  To get all results, use -1

```r
only_10 <- ga_data(
    my_property_id,
    metrics = c("activeUsers","sessions"),
    dimensions = c("date","city","dayOfWeek"),
    date_range = c("2020-03-31", "2020-04-27"),
    limit = 10
)

all_results <- ga_data(
    my_property_id,
    metrics = c("activeUsers","sessions"),
    dimensions = c("date","city","dayOfWeek"),
    date_range = c("2020-03-31", "2020-04-27"),
    limit = -1
)
```

## Filters

Filters are simpler to create but more flexible than in Universal Analytics. 

There is now only one filter function - `ga_data_filter()`.  As was the case for `google_analytics()` , you use the filter function to construct metric filters or dimension filters in the `dimensionFilter` or `metricFilter` parameters in your `ga_data()` call. 

### Making filter elements

The base object is `ga_data_filter()` - this holds the logic for the specific metric or dimension you are using.  The function uses a new DSL for GA4 filters, the syntax rules are detailed below: 

* A single filter, or multiple filters within a filter expression can be passed in to `ga_data()`
* The single filter syntax is (field) (operator) (value) e.g. `"city"=="Copenhagen"`
* (field) is a dimension or metric for your web property, which you can review via `ga_meta("data")`
* (operator) can be one of `==, >, >=, <, <=` for metrics
* (operator) can be one of `==, %begins%, %ends%, %contains%, %contains%, %regex%, %regex_partial%` for dimensions
* dimension (operator) are by default case sensitive. Make them case insensitive by using UPPER case variations `%BEGINS%, %ENDS%` etc. or `%==%` for case insensitive exact matches
* (value) can be strings (`"dim1"`), numerics (`55`), string vectors (`c("dim1", "dim2")`), numeric vectors (`c(1,2,3)`) or boolean (`TRUE`) which will correspond to different types of filters
* Filter expressions for multiple filters when using the operators: `&, |, !` which correspond to `AND`, `OR` and `NOT` respectively. 

#### Fields

Fields are metrics and dimensions that are available to your GA4 implementation, including custom fields.  You can see what is available by calling the `ga_meta("data")` function.

Do not construct metric filters and use in the `dimensionFilter` argument or vice-versa.

#### Values

Values are checked in the filter object based on the R class of the object you are passing in as its value:

* `character`: stringFilter - e.g. `"Copenhagen"`
* `character vector`: inListFilter e.g. `c("Copenhagen","London","New York")`
* `numeric`: NumericFilter e.g. `5`
* `numeric 2-length vector`: BetweenFilter e.g. `c(5, 10)`
* `logical`: TRUE will filter for NULL e.g. `TRUE`

e.g. if you pass in a character of length one (`"Copenhagen"`) then it will assume to be a class `StringFilter` (all dimensions that match "Copenhagen") if you pass in a character of length greater than one `c("Copenhagen","London","New York")`, then it assume to be a class `InListFilter` (dimensions must match one in the list)

### Examples Using filter elements

All filters are made up of filter expressions using `ga_data_filter()`:

```r
simple_filter <- ga_data(
   206670707,
   metrics = c("activeUsers","sessions"),
   dimensions = c("date","city","dayOfWeek"),
   date_range = c("2020-03-31", "2020-04-27"),
   dimensionFilter = ga_data_filter("city"=="Copenhagen"),
   limit = 100
   )
```

If you need more complicated filters, then build them using the DSL syntax.  This lets you combine `ga_data_filter()` objects in various ways.


```{r}
## filter clauses
# or string filter
ga_data_filter("city"=="Copenhagen" | "city" == "London")
# inlist string filter
ga_data_filter("city"==c("Copenhagen","London"))
# and string filters
ga_data_filter("city"=="Copenhagen" & "dayOfWeek" == "5")
# invert string filter
ga_data_filter(!("city"=="Copenhagen" | "city" == "London"))

# multiple filter clauses
ga_data_filter("city"==c("Copenhagen","London","Paris","New York") &
                       ("dayOfWeek"=="5" | "dayOfWeek"=="6"))
```

Numeric filters for use in `metricFilters`

```r
metric_filter <- ga_data(
   206670707,
   metrics = c("activeUsers","sessions"),
   dimensions = c("date","city","dayOfWeek"),
   date_range = c("2020-03-31", "2020-04-27"),
   metricFilter = ga_data_filter("sessions">10),
   limit = 100
   )
```

```{r}
## numeric filter types
# numeric equal filter
ga_data_filter("sessions"==5)
# between numeric filter
ga_data_filter("sessions"==c(5,6))
# greater than numeric
ga_data_filter("sessions" > 0)
# greater than or equal
ga_data_filter("sessions" >= 1)
# less than numeric
ga_data_filter("sessions" < 100)
# less than or equal numeric
ga_data_filter("sessions" <= 100)
```

All the string filters:

```{r}
## string filter types
# begins with string
ga_data_filter("city" %begins% "Cope")
# ends with string
ga_data_filter("city" %ends% "hagen")
# contains string
ga_data_filter("city" %contains% "ope")
# regex (full) string
ga_data_filter("city" %regex% "^Cope")
# regex (partial) string
ga_data_filter("city" %regex_partial% "ope")

# by default string filters are case sensitive.  
# Use UPPERCASE operator to make then case insensitive

# begins with string (case insensitive)
ga_data_filter("city" %BEGINS% "cope")
# ends with string (case insensitive)
ga_data_filter("city" %ENDS% "Hagen")
# case insensitive exact match
ga_data_filter("city" %==% "copeNHAGen")
```

You can also recursively nest filter expressions - this lets you build up complex filters:

```{r}
# use previously created filters to build another filter expression:
# multiple filter clauses
f1 <- ga_data_filter("city"==c("Copenhagen","London","Paris","New York") &
                       ("dayOfWeek"=="5" | "dayOfWeek"=="6")) 

# build up complicated filters
f2 <- ga_data_filter(f1 | "sessionSource"=="google")
f3 <- ga_data_filter(f2 & !"sessionMedium"=="cpc")
f3
```

The filter above looks for visitors from Copenhagen, London, Paris or New York who arrived on day 5 or 6 of the week, from Google referrers but not including Google Ads.

You can use filter expression objects above directly like so:

```r
complex_filter <- ga_data(
   206670707,
   metrics = c("activeUsers","sessions"),
   dimensions = c("date","city","dayOfWeek"),
   date_range = c("2020-03-31", "2020-04-27"),
   dimensionFilter = f3,
   limit = 100
   )
```

## Real Time Data

Real-time data can be fetched with the same function as the regular Data API, but it is calling another endpoint.  Add the `realtime=TRUE` argument to the function.

A limited subset of [dimensions and metrics are available in the real-time API](https://developers.google.com/analytics/devguides/reporting/data/v1/realtime-api-schema).  Date ranges are ignored.

```r
# run a real-time report 
realtime <- ga_data(
  206670707,
  metrics = "activeUsers",
  dimensions = "city",
  dimensionFilter = ga_data_filter("city"=="Copenhagen"),
  limit = 100,
  realtime = TRUE)
```

## Quotas

There is no sampling but there are token quotas for API fetches on a per-project basis.  Normally these are not visible until you are close to the quota limits, but you can see them if you set the googleAuthR verbose level below 3 (`options(googleAuthR.verbose=2)`))

The bigger and more complex the query you make, the more tokens you use.

An example from the query above:

```r
options(googleAuthR.verbose=2)
complex_filter <- ga_data(
     206670707,
     metrics = c("activeUsers","sessions"),
     dimensions = c("date","city","dayOfWeek"),
     date_range = c("2020-03-31", "2020-04-27"),
     dimensionFilter = f3,
     limit = 100
)
#>ℹ 2020-11-24 16:12:35 > Request:  https://analyticsdata.googleapis.com/v1alpha:batchRunReports/
#>ℹ 2020-11-24 16:12:35 > Body JSON parsed to:  #>{"entity":{"propertyId":"206670707"},"requests":[{"metrics":[{"name":"activeUsers"},{"name":"sessions"}],"dimensions":[{"name":"date"},{"name":"city"},{"name":"dayOfWeek"}],"dateRanges":[{"startDate":"2020-03-31","endDate":"2020-04-27"}],"keepEmptyRows":true,"dimensionFilter":{"andGroup":{"expressions":[{"orGroup":{"expressions":[{"andGroup":{"expressions":[{"filter":{"fieldName":"city","inListFilter":{"caseSensitive":true,"values":["Copenhagen","London","Paris","New York"]}}},{"orGroup":{"expressions":[{"filter":{"fieldName":"dayOfWeek","stringFilter":{"caseSensitive":true,"value":"5","matchType":"EXACT"}}},{"filter":{"fieldName":"dayOfWeek","stringFilter":{"caseSensitive":true,"value":"6","matchType":"EXACT"}}}]}}]}},{"filter":{"fieldName":"sessionSource","stringFilter":{"caseSensitive":true,"value":"google","matchType":"EXACT"}}}]}},{"notExpression":{"filter":{"fieldName":"sessionMedium","stringFilter":{"caseSensitive":true,"value":"cpc","matchType":"EXACT"}}}}]}},"limit":100,"returnPropertyQuota":true}]}
#>ℹ 2020-11-24 16:12:36 > tokensPerDay: Query Cost [ 11 ] / Remaining [ 24847 ]
#>ℹ 2020-11-24 16:12:36 > tokensPerHour: Query Cost [ 11 ] / Remaining [ 4967 ]
#>ℹ 2020-11-24 16:12:36 > concurrentRequests:  10  / 10
#>ℹ 2020-11-24 16:12:36 > serverErrorsPerProjectPerHour:  10  / 10
```

The quotas are:

* `tokensPerDay` - how many tokens in 24hrs
* `tokensPerHour` - how many tokens in 1 hr
* `concurrentRequests` - how many API requests at once
* `serverErrorsPerProjectPerHour` - how many bad API calls you can make per project/hr


---
title: "User Activity API"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The [User Activity API](https://developers.google.com/analytics/devguides/reporting/core/v4/rest/v4/userActivity/search) lets you query an individual user's movement through your website, by sending in the individual `clientId` or `userId`.  It is accessed via the `ga_clientid_activity()` function.

At the moment it is available on the dev version of `googleAnalyticsR >= 0.6.9000` so install via:

```r
remotes::install_github("MarkEdmondson1234/googleAnalyticsR")
```

## User Activity API example

You first need to have a `clientId` or `userId` to query.  You can get this via the User Explorer report in the Web UI, or via a BigQuery export, or you may be capturing the id in a custom dimension.  

If you know the ID from other sources such as you have set the `userId` from your CRM system.

Once you have an ID, specify the Google Analytics view that user was browsing and the data range of the activity you want to query:

```r
a_user <- ga_clientid_activity("1106980347.1461227730",
                               viewId = 81416156, 
                               date_range = c("2019-01-01","2019-02-01"))
```

## Multiple ids

You can send in multiple IDs of the same type in a vector:

```r
two_clientIds <- c("1106980347.1461227730", "476443645.1541099566")
two_users <- ga_clientid_activity(two_clientIds,
                                  viewId = 81416156, 
                                  date_range = c("2019-01-01","2019-02-01"))
```

## Return format

The API returns two types of data: session level and activity hit level.  Access it via `$sessions` or `$hits`:

```r
two_users$sessions
#    sessionId deviceCategory  platform dataSource sessionDate                    id
#1  1548361067        desktop Macintosh        web  2019-01-24 1106980347.1461227730
#2  1548261976        desktop Macintosh        web  2019-01-23 1106980347.1461227730
#3  1548251272        desktop Macintosh        web  2019-01-23 1106980347.1461227730
#4  1548017997        desktop Macintosh        web  2019-01-20 1106980347.1461227730
# ...

two_users$hits
# A tibble: 102 x 26
#   sessionId activityTime        source medium channelGrouping campaign keyword hostname
#   <chr>     <dttm>              <chr>  <chr>  <chr>           <chr>    <chr>   <chr>   
# 1 15483610… 2019-01-24 21:17:47 t.co   refer… Social          (not se… (not s… code.ma…
# 2 15482619… 2019-01-23 17:46:16 t.co   refer… Social          (not se… (not s… code.ma…
# 3 15482512… 2019-01-23 14:47:52 t.co   refer… Social          (not se… (not s… code.ma…
# ...
```

The amount of data returned is rich for the activity, the data columns are shown below (Although some will be empty for some rows if not applicable).  

```r
names(two_users$hits)
# [1] "sessionId"            "activityTime"         "source"               "medium"              
# [5] "channelGrouping"      "campaign"             "keyword"              "hostname"            
# [9] "landingPagePath"      "activityType"         "customDimension"      "pagePath"            
#[13] "pageTitle"            "screenName"           "mobileDeviceBranding" "mobileDeviceModel"   
#[17] "appName"              "ecommerce"            "goals"                "has_goal"            
#[21] "eventCategory"        "eventAction"          "eventLabel"           "eventValue"          
#[25] "eventCount"           "id" 
```

The data.frames returned include the id you sent in as the `$id` column so you can distinguish between users.

### Nested columns

The output uses nested columns for some values so you may want to get familiar with the `tidyr::unnest()` function when working with the data.

The nested columns are `hits$customDimension`, `hits$ecommerce` and `hits$goals`.

The nesting is necessary as you can have multiple of these events per hit, and expanding them in the response would make a very large `data.frame` to work with.

An example on how to unnest goals is shown below:

```r
library(tidyr)
library(purrr)
library(dplyr)

a_user$hits %>% 
  filter(has_goal) %>% # filter to just hits with goals
  select(id, sessionId, goals) %>% 
  unnest(goals) %>% # unnest the goals list column
  mutate(goalIndex = map_chr(goals, "goalIndex"), 
         goalName = map_chr(goals, "goalName"), 
         goalCompletionLocation = map_chr(goals, "goalCompletionLocation"))
# A tibble: 4 x 4
#  goals      goalIndex goalName             goalCompletionLocation                    
#  <list>     <chr>     <chr>                <chr>                                     
#1 <list [7]> 20        Visited over 4 pages /googleAnalyticsR/articles/setup.html     
#2 <list [7]> 1         Time over a minute 1 /googleAnalyticsR/articles/ganalytics.html
#3 <list [7]> 1         Time over a minute 1 /googleAnalyticsR/articles/v4.html        
#4 <list [7]> 1         Time over a minute 1 /googleAnalyticsR/
```

## Filtering the response

If you specify the `activity_type` parameter, you can filter down the response to only the events you include in a vector.  

The permitted types are: `c("PAGEVIEW","SCREENVIEW","GOAL","ECOMMERCE","EVENT")` - include some of these to specify which you would like to see.

```r
only_goals <- ga_clientid_activity(two_clientIds,
                                   viewId = 81416156, 
                                   date_range = c("2019-01-01","2019-02-01"),
                                   activity_types = "GOAL")
```

## Sampled response

The API response may be sampled - it will send a message if this happens.  If it does, follow the advice on the [API documentation](https://developers.google.com/analytics/devguides/reporting/core/v4/user-reporting) such as splitting up the call into smaller date ranges. 


<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Google Analytics Reporting API v4 R Examples. googleAnalyticsR</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet"><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container">
      <header><div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">googleAnalyticsR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Reporting API
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../../articles/v4.html">
        <span class="fa fa-cogs"></span>
         
        v4
      </a>
    </li>
    <li>
      <a href="../../articles/v3.html">
        <span class="fa fa-cog"></span>
         
        v3
      </a>
    </li>
  </ul></li>
<li>
  <a href="../../articles/big-query.html">
    <span class="fa fa-search"></span>
     
    Big Query
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Reporting
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../../articles/shiny.html">
        <span class="fa fa-cloud-upload"></span>
         
        Shiny
      </a>
    </li>
    <li>
      <a href="../../articles/rmarkdown.html">
        <span class="fa fa-pencil-square"></span>
         
        RMarkdown
      </a>
    </li>
  </ul></li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../../reference/index.html">
        <span class="fa fa-question-circle"></span>
         
        Reference
      </a>
    </li>
    <li>
      <a href="../../news/index.html">
        <span class="fa fa-newspaper-o"></span>
         
        News
      </a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Google Analytics Reporting API v4 R Examples</h1>
            
          </div>

    
    
<div id="v4-features" class="section level2">
<h2>v4 features</h2>
<p>The v4 API is where new features will appear in the future.</p>
<p>It currently has these extras implemented over the v3 API:</p>
<ul><li>Cohorts</li>
<li>Multiple date ranges</li>
<li>Pivot tables</li>
<li>Calculated metrics on the fly</li>
<li>Much more powerful segments</li>
</ul></div>
<div id="v4-api-explorer-shiny-app" class="section level2">
<h2>v4 API Explorer Shiny app</h2>
<p>A demo Shiny app where you can <a href="https://mark.shinyapps.io/googleAnalyticsRv4Demo/">explore the new v4 features</a> is available.</p>
<div class="figure">
<img src="/Users/IIH-Nordic/dev/googleAnalyticsR/vignettes/website/v4demoappexample.png"></div>
</div>
<div id="to-use---v4-api-calls" class="section level2">
<h2>To use - v4 API calls</h2>
<p>Consult <code>?google_analytics_4</code> and these example queries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## setup
<span class="kw">library</span>(googleAnalyticsR)

## authenticate, or use the RStudio Addin "Google API Auth" with analytics scopes set
<span class="kw"><a href="../../reference/ga_auth.html">ga_auth</a></span>()

## get your accounts
account_list &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_account_list.html">google_analytics_account_list</a></span>()

## pick a profile with data to query
ga_id &lt;-<span class="st"> </span>account_list[<span class="dv">23</span>,<span class="st">'viewId'</span>]</code></pre></div>
<div id="anti-sampling-v4" class="section level3">
<h3>Anti-sampling v4</h3>
<p>A new feature from version <code>0.3.0</code> is anti-sampling via batching.</p>
<p>Sampling is due to your API request being over the session limits <a href="https://support.google.com/analytics/answer/2637192">outlined in this Google article</a>. This limit is higher for Google Analytics 360.</p>
<p>If you split up your API request so that the number of sessions falls under these limits, sampling will not occur.</p>
<div id="sampled-data-example" class="section level4">
<h4>Sampled data example</h4>
<p>If you have sampling in your data request, <code>googleAnalyticsR</code> reports it back to you in the console when making the request.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">library</span>(googleAnalyticsR)
&gt;<span class="st"> </span><span class="kw"><a href="../../reference/ga_auth.html">ga_auth</a></span>()
&gt;<span class="st"> </span>sampled_data_fetch &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(id, 
                                           <span class="dt">date_range =</span> <span class="kw">c</span>(&ldquo;<span class="dv">2015-01-01</span>&rdquo;,&rdquo;<span class="dv">2015-06-21</span><span class="st">"), </span>
<span class="st">                                           metrics = c("</span>users<span class="st">","</span>sessions<span class="st">","</span>bounceRate<span class="st">"), </span>
<span class="st">                                           dimensions = c("</span>date<span class="st">","</span>landingPagePath<span class="st">","</span>source<span class="st">"))</span>
<span class="st">Calling APIv4....</span>
<span class="st">Data is sampled, based on 39.75% of visits.</span></code></pre></div>
</div>
<div id="unsampled-data-example" class="section level4">
<h4>Unsampled data example</h4>
<p>Setting the new argument <code>anti_sample=TRUE</code> in a <code><a href="../../reference/google_analytics_4.html">google_analytics_4()</a></code> request now causes the calls to be split up into small enough chunks to avoid sampling. This uses more API calls so the data will reach you slower, but it should hold more detail.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">library</span>(googleAnalyticsR)
&gt;<span class="st"> </span><span class="kw"><a href="../../reference/ga_auth.html">ga_auth</a></span>()
&gt;<span class="st"> </span>unsampled_data_fetch &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(id, 
                                             <span class="dt">date_range =</span> <span class="kw">c</span>(&ldquo;<span class="dv">2015-01-01</span>&rdquo;,&rdquo;<span class="dv">2015-06-21</span><span class="st">"), </span>
<span class="st">                                             metrics = c("</span>users<span class="st">","</span>sessions<span class="st">","</span>bounceRate<span class="st">"), </span>
<span class="st">                                             dimensions = c("</span>date<span class="st">","</span>landingPagePath<span class="st">","</span>source<span class="st">"),</span>
<span class="st">                                             anti_sample = TRUE)</span>

<span class="st">anti_sample set to TRUE. Mitigating sampling via multiple API calls.</span>
<span class="st">Finding how much sampling in data request...</span>
<span class="st">Data is sampled, based on 39.75% of visits.</span>
<span class="st">Downloaded [10] rows from a total of [59235].</span>
<span class="st">Finding number of sessions for anti-sample calculations...</span>
<span class="st">Downloaded [172] rows from a total of [172].</span>
<span class="st">Calculated [3] batches are needed to download [59235] rows unsampled.</span>
<span class="st">Anti-sample call covering 128 days: 2015-01-01, 2015-05-08</span>
<span class="st">Looping over [2] batches.</span>
<span class="st">Fetching data...</span>
<span class="st">Fetching data...</span>
<span class="st">Downloaded [59235] rows from a total of [59235].</span>
<span class="st">Anti-sample call covering 23 days: 2015-05-09, 2015-05-31</span>
<span class="st">Looping over [2] batches.</span>
<span class="st">Fetching data...</span>
<span class="st">Fetching data...</span>
<span class="st">Downloaded [20239] rows from a total of [20239].</span>
<span class="st">Anti-sample call covering 21 days: 2015-06-01, 2015-06-21</span>
<span class="st">Looping over [2] batches.</span>
<span class="st">Fetching data...</span>
<span class="st">Fetching data...</span>
<span class="st">Downloaded [21340] rows from a total of [21340].</span>
<span class="st">Finished unsampled data request, total rows [100814]</span>
<span class="st">Successfully avoided sampling</span></code></pre></div>
<p>The sequence involves a couple of exploratory API calls to determine the best split. This method will adjust the time periods to have the batch sizes large enough to not take too long, but small enough to have unsampled data.</p>
</div>
<div id="auto-anti-sampling-failure" class="section level4">
<h4>Auto-anti sampling failure</h4>
<p>In some cases the anti-sampling won&rsquo;t work. This will mainly be due to filters for the View you are using meaning that the calculation for the sampling sessions are incorrect - Google Analytics vanilla samples on a property level (whilst GA360 samples on a View level).</p>
<p>Try using a raw profile if you can, otherwise you can set your own sample period by using the <code>anti_sample_batches</code> flag to indicate the sample size. Pick a number that is a little lower than the smallest period you saw in the auto-sample batches. If in doubt, setting <code>anti_sample_batches</code> to 1 will make a daily fetch.</p>
</div>
<div id="hourly-anti-sampling-calls" class="section level4">
<h4>Hourly anti-sampling calls</h4>
<p>For large traffic websites, sometimes even if the batches are down to one API call per day, it isn&rsquo;t enough to remove sampling. In those cases, <code>googleAnalyticsR</code> will split the calls further into hourly batches.</p>
<p>If you are still experiencing sampling with hourly batches, then its time to use the <a href="big-query.html">google_analytics_bq</a> function :)</p>
</div>
</div>
<div id="new-filter-syntax" class="section level3">
<h3>New Filter Syntax</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## create filters on metrics
mf &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/met_filter.html">met_filter</a></span>(<span class="st">"bounces"</span>, <span class="st">"GREATER_THAN"</span>, <span class="dv">0</span>)
mf2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/met_filter.html">met_filter</a></span>(<span class="st">"sessions"</span>, <span class="st">"GREATER"</span>, <span class="dv">2</span>)

## create filters on dimensions
df &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dim_filter.html">dim_filter</a></span>(<span class="st">"source"</span>,<span class="st">"BEGINS_WITH"</span>,<span class="st">"1"</span>,<span class="dt">not =</span> <span class="ot">TRUE</span>)
df2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dim_filter.html">dim_filter</a></span>(<span class="st">"source"</span>,<span class="st">"BEGINS_WITH"</span>,<span class="st">"a"</span>,<span class="dt">not =</span> <span class="ot">TRUE</span>)

## construct filter objects
fc2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/filter_clause_ga4.html">filter_clause_ga4</a></span>(<span class="kw">list</span>(df, df2), <span class="dt">operator =</span> <span class="st">"AND"</span>)
fc &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/filter_clause_ga4.html">filter_clause_ga4</a></span>(<span class="kw">list</span>(mf, mf2), <span class="dt">operator =</span> <span class="st">"AND"</span>)

## make v4 request
## demo showing how the new filters work
ga_data1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                              <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span>),
                              <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'medium'</span>), 
                              <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>), 
                              <span class="dt">met_filters =</span> fc, 
                              <span class="dt">dim_filters =</span> fc2, 
                              <span class="dt">filtersExpression =</span> <span class="st">"ga:source!=(direct)"</span>)

ga_data1

<span class="co">#                     source   medium sessions bounces</span>
<span class="co"># 1                  baby.dk referral        3       2</span>
<span class="co"># 2                     bing  organic       71      42</span>
<span class="co"># 3  buttons-for-website.com referral        7       7</span>
<span class="co"># 4           duckduckgo.com referral        5       3</span>
<span class="co"># 5                   google  organic      642     520</span>
<span class="co"># 6                google.se referral        3       2</span>
<span class="co"># 7                 izito.se referral        3       1</span>
<span class="co"># 8          success-seo.com referral       35      35</span>
<span class="co"># 9    video--production.com referral       11      11</span>
<span class="co"># 10                   yahoo  organic       66      43</span>
<span class="co"># 11              zapmeta.se referral        6       4</span></code></pre></div>
</div>
<div id="querying-multiple-report-types-at-a-time" class="section level3">
<h3>Querying multiple report types at a time</h3>
<p>Example with two date ranges and two reports. When querying two date ranges, you can sort the metrics by how much they have changed by using <code>orderType = DELTA</code> e.g. <code><a href="../../reference/order_type.html">order_type("sessions", "DESCENDING", "DELTA")</a></code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## demo of querying two date ranges at a time   
## we make the request via make_ga_4_req() to use in next demo
multidate_test &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/make_ga_4_req.html">make_ga_4_req</a></span>(ga_id, 
                                <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,
                                               <span class="st">"2015-10-01"</span>,
                                               <span class="st">"2014-07-30"</span>,
                                               <span class="st">"2014-10-01"</span>),
                                <span class="dt">dimensions =</span> <span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'medium'</span>), 
                                <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>),
                                <span class="dt">order =</span> <span class="kw"><a href="../../reference/order_type.html">order_type</a></span>(<span class="st">"sessions"</span>, <span class="st">"DESCENDING"</span>, <span class="st">"DELTA"</span>))
                                
ga_data2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/fetch_google_analytics_4.html">fetch_google_analytics_4</a></span>(multidate_test)
ga_data2
<span class="co">#                                     source      medium sessions.d1 bounces.d1 sessions.d2 bounces.d2</span>
<span class="co"># 1                                 (direct)      (none)        5923       3328           0          0</span>
<span class="co"># 2                        example_mem.co.uk    referral        5846       1100           0          0</span>
<span class="co"># 3                                   google         cpc        5476       2669           0          0</span>
<span class="co"># 4                           examp-link.net    referral        2241        653           0          0</span>
<span class="co"># 5                    moneysavingexampl.com    referral        1869        549           0          0</span>
<span class="co"># 6                            emailCampaign       email        1268        772           0          0</span>


## Demo querying two reports at the same time
## Use make_ga_4_req() to make multiple requests and then send 
##   them as a list to fetch_google_analytics_4()
multi_test2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/make_ga_4_req.html">make_ga_4_req</a></span>(ga_id,
                                <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,
                                               <span class="st">"2015-10-01"</span>,
                                               <span class="st">"2014-07-30"</span>,
                                               <span class="st">"2014-10-01"</span>),
                             <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'hour'</span>,<span class="st">'medium'</span>), 
                             <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'visitors'</span>,<span class="st">'bounces'</span>))

## all requests must have same viewID and dateRange
ga_data3 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/fetch_google_analytics_4.html">fetch_google_analytics_4</a></span>(<span class="kw">list</span>(multidate_test, multi_test2)) 
ga_data3
<span class="co"># [[1]]</span>
<span class="co">#                     source   medium sessions.d1 bounces.d1 sessions.d2 bounces.d2</span>
<span class="co"># 1                  baby.dk referral           3          2           6          3</span>
<span class="co"># 2                     bing  organic          71         42         217        126</span>
<span class="co"># 3  buttons-for-website.com referral           7          7           0          0</span>
<span class="co"># 4           duckduckgo.com referral           5          3           0          0</span>
<span class="co"># 5                   google  organic         642        520        1286        920</span>
<span class="co"># 6                google.se referral           3          2          12          9</span>
<span class="co"># 7                 izito.se referral           3          1           0          0</span>
<span class="co"># 8          success-seo.com referral          35         35           0          0</span>
<span class="co"># 9    video--production.com referral          11         11           0          0</span>
<span class="co"># 10                   yahoo  organic          66         43         236        178</span>
<span class="co"># 11              zapmeta.se referral           6          4           9          4</span>
<span class="co"># </span>
<span class="co"># [[2]]</span>
<span class="co">#    hour   medium visitors.d1 bounces.d1 visitors.d2 bounces.d2</span>
<span class="co"># 1    00  organic          28         16          85         59</span>
<span class="co"># 2    00 referral           3          2           1          1</span>
<span class="co"># 3    01  organic          43         28          93         66</span>
</code></pre></div>
</div>
<div id="on-the-fly-calculated-metrics" class="section level3">
<h3>On-the-fly calculated metrics</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ga_data4 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id,
                               <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,
                                              <span class="st">"2015-10-01"</span>),
                              <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'medium'</span>), 
                              <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="dt">visitsPerVisitor =</span> <span class="st">"ga:visits/ga:visitors"</span>,
                                          <span class="st">'bounces'</span>), 
                              <span class="dt">metricFormat =</span> <span class="kw">c</span>(<span class="st">"FLOAT"</span>,<span class="st">"INTEGER"</span>))
ga_data4
<span class="co">#     medium visitsPerVisitor bounces</span>
<span class="co"># 1   (none)         1.000000     117</span>
<span class="co"># 2  organic         1.075137     612</span>
<span class="co"># 3 referral         1.012500      71</span></code></pre></div>
</div>
<div id="segments-v4" class="section level3">
<h3>Segments v4</h3>
<p>Segments are more complex to configure that v3, but more powerful and in line to how you configure them in the UI.</p>
<p>A lot of feedback for the library is on how to get the segment syntax right, so the examples below try to cover common scenarios.</p>
<div id="v3-segments" class="section level4">
<h4>v3 segments</h4>
<p>You can choose to create segments via the v4 syntax or the v3 syntax for backward compatibility.</p>
<p>If you want to use v3 segments, then they can be used in the <code>segment_id</code> argument of the <code><a href="../../reference/segment_ga4.html">segment_ga4()</a></code> function.</p>
<p>You can view the segment Ids by using <code><a href="../../reference/ga_segment_list.html">ga_segment_list()</a></code> and the data.frame in <code>$items</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## get list of segments
my_segments &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/ga_segment_list.html">ga_segment_list</a></span>()

## just the segment items
segs &lt;-<span class="st"> </span>my_segments$items

## segment Ids and name:
segs[,<span class="kw">c</span>(<span class="st">"name"</span>,<span class="st">"id"</span>,<span class="st">"defintion"</span>)]

## example output
  id            name                                                          definition
<span class="dv">1</span> -<span class="dv">1</span>       All Users                                                                    
<span class="dv">2</span> -<span class="dv">2</span>       New Users                       sessions::condition::ga:userType==New Visitor
<span class="dv">3</span> -<span class="dv">3</span> Returning Users                 sessions::condition::ga:userType==Returning Visitor
<span class="dv">4</span> -<span class="dv">4</span>    Paid Traffic         sessions::condition::ga:medium=<span class="er">~^</span>(cpc|ppc|cpa|cpm|cpv|cpp)$
<span class="dv">5</span> -<span class="dv">5</span> Organic Traffic                             sessions::condition::ga:medium==organic
<span class="dv">6</span> -<span class="dv">6</span>  Search Traffic sessions::condition::ga:medium=<span class="er">~^</span>(cpc|ppc|cpa|cpm|cpv|cpp|organic)$
....</code></pre></div>
<p>The ID you require is in the <code>$id</code> column which you need to prefix with &ldquo;gaid::&rdquo;</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## choose the v3 segment
segment_for_call &lt;-<span class="st"> "gaid::-4"</span>

## make the v3 segment object in the v4 segment object:
seg_obj &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_ga4.html">segment_ga4</a></span>(<span class="st">"PaidTraffic"</span>, <span class="dt">segment_id =</span> segment_for_call)

## make the segment call
segmented_ga1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                                    <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span>), 
                                    <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span>), 
                                    <span class="dt">segments =</span> seg_obj, 
                                    <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>)
                                    )
  </code></pre></div>
<p>&hellip;or you can pass the v3 syntax for dynamic segments found from the <code>$definition</code> column:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## or pass the segment v3 defintion in directly:
segment_def_for_call &lt;-<span class="st"> "sessions::condition::ga:medium=~^(cpc|ppc|cpa|cpm|cpv|cpp)$"</span>

## make the v3 segment object in the v4 segment object:
seg_obj &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_ga4.html">segment_ga4</a></span>(<span class="st">"PaidTraffic"</span>, <span class="dt">segment_id =</span> segment_def_for_call)

## make the segment call
segmented_ga1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                                    <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span>), 
                                    <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span>), 
                                    <span class="dt">segments =</span> seg_obj, 
                                    <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>)
                                    )</code></pre></div>
</div>
<div id="v4-segment-syntax" class="section level4">
<h4>v4 segment syntax</h4>
<p>However, its recommended you embrace the new v4 syntax, as its more flexible and powerful in the long run.</p>
<p>The hierarachy of the segment elements you will need are:</p>
<ul><li><em><code><a href="../../reference/segment_ga4.html">segment_ga4()</a></code></em> - this is the top of the segment tree. You can pass one or a list of these into a <code><a href="../../reference/google_analytics_4.html">google_analytics_4()</a></code> segment argument. Here you name the segment as it will appear in the <code>segment</code> dimension, and pass in segment definitions either via an existing segmentID or v3 definition; via a user scoped level; or via a session scoped level. The user and session scopes can have one or a list of <code><a href="../../reference/segment_define.html">segment_define()</a></code> functions.</li>
<li><em><code><a href="../../reference/segment_define.html">segment_define()</a></code></em> - this is where you define the types of segment filters that you are passing in - they are combined in a logical AND. The segment filters can be of a <code>segment_vector_simple</code> type (where order doesn&rsquo;t matter) or a <code>segment_vector_sequence</code> type (where order does matter.) You can also pass in a <code>not_vector</code> of the same length as the list of segment filters, which dictates if the segments you pass in are included (the default) or excluded.</li>
<li><em><code><a href="../../reference/segment_vector_simple.html">segment_vector_simple()</a></code></em> and <em><code><a href="../../reference/segment_vector_sequence.html">segment_vector_sequence()</a></code></em> - these are vectors of <code>segment_element</code>, and determine if the conditions are included in a logical OR fashion, or if the sequence of steps is important (for instance users who saw this page, then that page.)<br></li>
<li><em><code>segment_element</code></em> - this is the lowest atom of segments, and lets you define on which metric or dimension you are segmenting on. You pass one or a list of these to <em><code><a href="../../reference/segment_vector_simple.html">segment_vector_simple()</a></code></em> or <em><code><a href="../../reference/segment_vector_sequence.html">segment_vector_sequence()</a></code></em></li>
</ul><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## make two segment elements
se &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"sessions"</span>, 
                      <span class="dt">operator =</span> <span class="st">"GREATER_THAN"</span>, 
                      <span class="dt">type =</span> <span class="st">"METRIC"</span>, 
                      <span class="dt">comparisonValue =</span> <span class="dv">1</span>, 
                      <span class="dt">scope =</span> <span class="st">"USER"</span>)
                      
se2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"medium"</span>, 
                      <span class="dt">operator =</span> <span class="st">"EXACT"</span>, 
                      <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                      <span class="dt">expressions =</span> <span class="st">"organic"</span>)

## choose between segment_vector_simple or segment_vector_sequence
## Elements can be combined into clauses, which can then be combined into OR filter clauses
sv_simple &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_vector_simple.html">segment_vector_simple</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(se)))

sv_simple2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_vector_simple.html">segment_vector_simple</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(se2)))

## Each segment vector can then be combined into a logical AND
seg_defined &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_define.html">segment_define</a></span>(<span class="kw">list</span>(sv_simple, sv_simple2))

## Each segement defintion can apply to users, sessions or both.
## You can pass a list of several segments
segment4 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_ga4.html">segment_ga4</a></span>(<span class="st">"simple"</span>, <span class="dt">user_segment =</span> seg_defined)

## Add the segments to the segments param
segment_example &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                                      <span class="kw">c</span>(<span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span>), 
                                      <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span>), 
                                      <span class="dt">segments =</span> segment4, 
                                      <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>)
                                      )

segment_example
<span class="co">#                            source   medium segment sessions bounces</span>
<span class="co"># 1                        24.co.uk referral  simple        1       1</span>
<span class="co"># 2                     aidsmap.com referral  simple        1       0</span>
<span class="co"># 3                             aol  organic  simple       30      19</span>
<span class="co"># 4                             ask  organic  simple       32      17</span>


## Sequence segment
  
  se2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"medium"</span>, 
                         <span class="dt">operator =</span> <span class="st">"EXACT"</span>, 
                         <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                         <span class="dt">expressions =</span> <span class="st">"organic"</span>)
  
  se3 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"medium"</span>,
                         <span class="dt">operator =</span> <span class="st">"EXACT"</span>,
                         <span class="dt">type =</span> <span class="st">"DIMENSION"</span>,
                         <span class="dt">not =</span> <span class="ot">TRUE</span>,
                         <span class="dt">expressions =</span> <span class="st">"organic"</span>)
  
  ## step sequence
  ## users who arrived via organic then via referral
  sv_sequence &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_vector_sequence.html">segment_vector_sequence</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(se2), 
                                              <span class="kw">list</span>(se3)))
  
  seq_defined2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_define.html">segment_define</a></span>(<span class="kw">list</span>(sv_sequence))
  
  segment4_seq &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_ga4.html">segment_ga4</a></span>(<span class="st">"sequence"</span>, <span class="dt">user_segment =</span> seq_defined2)
  
  ## Add the segments to the segments param
  segment_seq_example &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                                            <span class="kw">c</span>(<span class="st">"2016-01-01"</span>,<span class="st">"2016-03-01"</span>), 
                                            <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>,<span class="st">'segment'</span>), 
                                            <span class="dt">segments =</span> segment4_seq,
                                            <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>,<span class="st">'bounces'</span>)
  )
  
segment_seq_example
<span class="co">#                                source  segment sessions bounces</span>
<span class="co"># 1                                 aol sequence        1       0</span>
<span class="co"># 2                                 ask sequence        5       1</span>
<span class="co"># 3      bestbackpackersinsurance.co.uk sequence        9       6</span>
<span class="co"># 4                                bing sequence       22       2</span></code></pre></div>
<p>Some more examples, using some of the match types, contributed by Pawel Kapuscinski:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">con1 &lt;-<span class="kw"><a href="../../reference/segment_vector_simple.html">segment_vector_simple</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(<span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"ga:dimension1"</span>, 
                      <span class="dt">operator =</span> <span class="st">"REGEXP"</span>, 
                      <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                      <span class="dt">expressions =</span> <span class="st">".*"</span>, 
                      <span class="dt">scope =</span> <span class="st">"SESSION"</span>))))

con2 &lt;-<span class="kw"><a href="../../reference/segment_vector_simple.html">segment_vector_simple</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(<span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"ga:deviceCategory"</span>, 
                      <span class="dt">operator =</span> <span class="st">"EXACT"</span>, 
                      <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                      <span class="dt">expressions =</span> <span class="st">"Desktop"</span>, 
                      <span class="dt">scope =</span> <span class="st">"SESSION"</span>))))

seq1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"ga:pagePath"</span>, 
                         <span class="dt">operator =</span> <span class="st">"EXACT"</span>, 
                         <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                         <span class="dt">expressions =</span> <span class="st">"yourdomain.com/page-path"</span>, 
                         <span class="dt">scope =</span> <span class="st">"SESSION"</span>)


seq2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_element.html">segment_element</a></span>(<span class="st">"ga:eventAction"</span>, 
                         <span class="dt">operator =</span> <span class="st">"REGEXP"</span>, 
                         <span class="dt">type =</span> <span class="st">"DIMENSION"</span>, 
                         <span class="dt">expressions =</span> <span class="st">"english"</span>, 
                         <span class="dt">scope =</span> <span class="st">"SESSION"</span>,
                         <span class="dt">matchType =</span> <span class="st">"IMMEDIATELY_PRECEDES"</span>)

allSEQ &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/segment_vector_sequence.html">segment_vector_sequence</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(seq1), <span class="kw">list</span>(seq2)))

results &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                             <span class="dt">date_range =</span> <span class="kw">c</span>(<span class="st">"2016-08-08"</span>,<span class="st">"2016-09-08"</span>),
                             <span class="dt">segments =</span> <span class="kw"><a href="../../reference/segment_ga4.html">segment_ga4</a></span>(<span class="st">"sequence+condition"</span>,
                                                    <span class="dt">user_segment =</span> <span class="kw"><a href="../../reference/segment_define.html">segment_define</a></span>(<span class="kw">list</span>(con1,con2,allSEQ))
                                                    ),
                             <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'ga:users'</span>),
                             <span class="dt">dimensions =</span> <span class="kw">c</span>(<span class="st">'ga:segment'</span>))
</code></pre></div>
</div>
<div id="rstudio-addin-segment-helper" class="section level4">
<h4>RStudio Addin: Segment helper</h4>
<p>New in version 0.2.0 is an RStudio Addin to help create segments via a UI rather than the lists above.</p>
<p>You can call it via <code>googleAnalyticsR:::gadget_GASegment()</code> or within the RStudio interface like displayed below:</p>
<div class="figure">
<img src="/Users/IIH-Nordic/dev/googleAnalyticsR/vignettes/website/googleAnalyticsRsegmentCreator.gif" alt="Google Analytics v4 segment RStudio Addin"><p class="caption">Google Analytics v4 segment RStudio Addin</p>
</div>
</div>
</div>
<div id="cohort-reports" class="section level3">
<h3>Cohort reports</h3>
<p>Details on <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/advanced#cohorts">cohort reports and LTV can be found here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## first make a cohort group
cohort4 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/make_cohort_group.html">make_cohort_group</a></span>(<span class="kw">list</span>(<span class="st">"Jan2016"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">"2016-01-01"</span>, <span class="st">"2016-01-31"</span>), 
                                <span class="st">"Feb2016"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">"2016-02-01"</span>,<span class="st">"2016-02-28"</span>)))

## then call cohort report.  No date_range and must include metrics and dimensions
##   from the cohort list
cohort_example &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                                     <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'cohort'</span>), 
                                     <span class="dt">cohort =</span> cohort4, 
                                     <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'cohortTotalUsers'</span>))

cohort_example
<span class="co">#    cohort cohortTotalUsers</span>
<span class="co"># 1 Feb2016            19040</span>
<span class="co"># 2 Jan2016            23378</span></code></pre></div>
</div>
<div id="pivot-requests" class="section level3">
<h3>Pivot Requests</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## filter pivot results to 
pivot_dim_filter1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dim_filter.html">dim_filter</a></span>(<span class="st">"medium"</span>,
                                <span class="st">"REGEXP"</span>,
                                <span class="st">"organic|social|email|cpc"</span>)
                                
pivot_dim_clause &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/filter_clause_ga4.html">filter_clause_ga4</a></span>(<span class="kw">list</span>(pivot_dim_filter1))

pivme &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/pivot_ga4.html">pivot_ga4</a></span>(<span class="st">"medium"</span>,
                   <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">"sessions"</span>), 
                   <span class="dt">maxGroupCount =</span> <span class="dv">4</span>, 
                   <span class="dt">dim_filter_clause =</span> pivot_dim_clause)

pivtest1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/google_analytics_4.html">google_analytics_4</a></span>(ga_id, 
                               <span class="kw">c</span>(<span class="st">"2016-01-30"</span>,<span class="st">"2016-10-01"</span>), 
                               <span class="dt">dimensions=</span><span class="kw">c</span>(<span class="st">'source'</span>), 
                               <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'sessions'</span>), 
                               <span class="dt">pivots =</span> <span class="kw">list</span>(pivme))


<span class="kw">names</span>(pivtest1)
<span class="co">#  [1] "source"                      "sessions"                    "medium.referral.sessions"   </span>
<span class="co">#  [4] "medium..none..sessions"      "medium.cpc.sessions"         "medium.email.sessions"      </span>
<span class="co">#  [7] "medium.social.sessions"      "medium.twitter.sessions"     "medium.socialMedia.sessions"</span>
<span class="co"># [10] "medium.Social.sessions"      "medium.linkedin.sessions"  </span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#v4-features">v4 features</a></li>
      <li><a href="#v4-api-explorer-shiny-app">v4 API Explorer Shiny app</a></li>
      <li><a href="#to-use---v4-api-calls">To use - v4 API calls</a></li>
      </ul></div>
      </div>

</div>


      <footer><p>Built by <a href="http://hadley.github.io/pkgdown/">pkgdown</a>. Styled with <a href="http://getbootstrap.com">Bootstrap 3</a>.</p>
      </footer></div>

  </body></html>

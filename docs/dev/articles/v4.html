<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Analytics Reporting API v4 in R Examples • googleAnalyticsR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Google Analytics Reporting API v4 in R Examples">
<meta property="og:description" content="googleAnalyticsR">
<meta property="og:image" content="https://code.markedmondson.me/googleAnalyticsR/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleAnalyticsR</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.8.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fas fa-wrench"></span>
     
    Setup
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-table"></span>
     
    Reporting APIs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/reporting-ga4.html">
        <span class="fas fa-digital-tachograph"></span>
         
        GA4 Data API
      </a>
    </li>
    <li>
      <a href="../articles/v4.html">
        <span class="fas fa-cogs"></span>
         
        v4 API
      </a>
    </li>
    <li>
      <a href="../articles/user-activity.html">
        <span class="fas fa-user"></span>
         
        User Activity API
      </a>
    </li>
    <li>
      <a href="../articles/v3.html">
        <span class="fas fa-cog"></span>
         
        v3 API
      </a>
    </li>
    <li>
      <a href="../articles/big-query.html">
        <span class="fas fa-search"></span>
         
        BigQuery
      </a>
    </li>
    <li>
      <a href="../articles/ganalytics.html">
        <span class="fas fa-bullseye"></span>
         
        ganalytics
      </a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/management.html">
    <span class="fas fa-briefcase"></span>
     
    Management API
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file"></span>
     
    Publishing
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/shiny.html">
        <span class="fas fa-cloud-upload"></span>
         
        Shiny
      </a>
    </li>
    <li>
      <a href="../articles/rmarkdown.html">
        <span class="fas fa-pencil-square"></span>
         
        RMarkdown
      </a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-calculator"></span>
     
    Models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/models.html">
        <span class="fas fa-calculator"></span>
         
        Creating Models
      </a>
    </li>
    <li>
      <a href="../articles/model-templates.html">
        <span class="fas fa-photo-video"></span>
         
        Shiny Model Templates
      </a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-question-circle"></span>
     
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">
        <span class="fas fa-book-reader"></span>
         
        Function Reference
      </a>
    </li>
    <li>
      <a href="../news/index.html">
        <span class="fas fa-newspaper"></span>
         
        News
      </a>
    </li>
    <li>
      <a href="../articles/faq.html">
        <span class="fas fa-glasses"></span>
         
        FAQs
      </a>
    </li>
    <li>
      <a href="../articles/practical-tips.html">
        <span class="fas fa-bicycle"></span>
         
        Practical tips
      </a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleAnalyticsR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="v4_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Google Analytics Reporting API v4 in R Examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleAnalyticsR/blob/master/vignettes/v4.Rmd"><code>vignettes/v4.Rmd</code></a></small>
      <div class="hidden name"><code>v4.Rmd</code></div>

    </div>

    
    
<p>The v4 API supports Universal Analytics. For working with Google Analytics 4 (App+Web) use the new Data API.</p>
<p>The v4 API currently has these extras implemented over the v3 API:</p>
<ul>
<li>Cohorts</li>
<li>Multiple date ranges</li>
<li>Pivot tables</li>
<li>Calculated metrics on the fly</li>
<li>Much more powerful segments</li>
<li>Quota system for GA360</li>
<li>Caching</li>
</ul>
<p>Check out more examples on using the API in actual use cases on the <a href="http://www.dartistics.com/googleanalytics/index.html">www.dartistics.com website</a>.</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>To get started refer to the tutorials linked on the homepage, consult <code><a href="../reference/google_analytics.html">?google_analytics</a></code> when within R to see the documentation, and see these example queries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## setup</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleAnalyticsR/">googleAnalyticsR</a></span><span class="op">)</span>

<span class="co">## authenticate</span>
<span class="fu"><a href="../reference/ga_auth.html">ga_auth</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## get your accounts</span>
<span class="va">account_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ga_account_list.html">ga_account_list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## account_list will have a column called "viewId"</span>
<span class="va">account_list</span><span class="op">$</span><span class="va">viewId</span>

<span class="co">## View account_list and pick the viewId you want to extract data from</span>
<span class="va">ga_id</span> <span class="op">&lt;-</span> <span class="fl">123456</span>

<span class="co">## simple query to test connection</span>
<span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></code></pre></div>
<p><a href="http://jeffgswanson.com/">Jeff Swanson</a> has made a video guide that goes into more detail about the above examples (<a href="https://www.youtube.com/watch?v=S9mSh5kcRgc&amp;feature=share">Digital Marketing in R: How to Connect to Google Analytics API</a>) and is embedded below, many thanks to Jeff.</p>
<iframe width="560" height="315" src="http://www.youtube.com/embed/S9mSh5kcRgc?rel=0" frameborder="0" allowfullscreen>
</iframe>
</div>
<div id="number-of-results" class="section level2">
<h2 class="hasAnchor">
<a href="#number-of-results" class="anchor"></a>Number of results</h2>
<p>By default the function will return 1000 results. If you want to fetch all rows, set <code>max = -1</code></p>
<p>You don’t have to worry about paging through the API results, the library deals with that for you.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 1000 rows only</span>
<span class="va">thousand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                             metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                             dimensions <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span>

<span class="co"># 2000 rows</span>
<span class="va">twothousand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                             metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                             dimensions <span class="op">=</span> <span class="st">"date"</span>,
                             max <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>  

<span class="co"># All rows</span>
<span class="va">alldata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                             metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                             dimensions <span class="op">=</span> <span class="st">"date"</span>,
                             max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>   </code></pre></div>
<p>If you are using anti-sampling, it will always fetch all rows. This is because it won’t make sense to fetch only the top results as the API splits up the calls over all days. If you want to limit it afterwards, use R by doing something like:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## anti_sample gets all results (max = -1)</span>
<span class="va">gadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">myID</span>,
                      date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span>,
                      metrics <span class="op">=</span> <span class="st">"pageviews"</span>,
                      dimensions <span class="op">=</span> <span class="st">"pageTitle"</span>,
                      segments <span class="op">=</span> <span class="va">myseg</span>,
                      anti_sample <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## limit to top 25</span>
<span class="va">top_25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gadata</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">gadata</span><span class="op">$</span><span class="va">pageviews</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span> , <span class="fl">25</span><span class="op">)</span></code></pre></div>
</div>
<div id="date-ranges" class="section level2">
<h2 class="hasAnchor">
<a href="#date-ranges" class="anchor"></a>Date Ranges</h2>
<p>You can send in dates in <code>YYYY-MM-DD</code> format:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="fl">868768</span>, date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-12-31"</span>, <span class="st">"2017-02-01"</span><span class="op">)</span>, metrics <span class="op">=</span> <span class="st">"sessions"</span><span class="op">)</span></code></pre></div>
<p>Character strings are converted into <code>Date</code> class objects, so you can also use R’s native <code>Date</code> object handling to specify rolling dates:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">yesterday</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
<span class="va">ThreedaysAgo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">3</span>

<span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="fl">868768</span>, date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ThreedaysAgo</span>, <span class="va">yesterday</span><span class="op">)</span>, metrics <span class="op">=</span> <span class="st">"sessions"</span><span class="op">)</span></code></pre></div>
<p>Or use the v4 API shortcuts directly such as <code>"yesterday"</code>, <code>"today"</code> or <code>"XDaysAgo"</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="fl">868768</span>, date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5daysAgo"</span>, <span class="st">"yesterday"</span><span class="op">)</span>, metrics <span class="op">=</span> <span class="st">"sessions"</span><span class="op">)</span></code></pre></div>
<div id="compare-date-ranges" class="section level3">
<h3 class="hasAnchor">
<a href="#compare-date-ranges" class="anchor"></a>Compare date ranges</h3>
<p>In v4 you can compare date ranges and return the two data sets in one call. Send in a 4-length vector of dates in the form <code>(range1_start, range1_end, range2_start, range2_end)</code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="fl">868768</span>, 
                   date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"16daysAgo"</span>, <span class="st">"9daysAgo"</span>, <span class="st">"8daysAgo"</span>, <span class="st">"yesterday"</span><span class="op">)</span>, 
                   metrics <span class="op">=</span> <span class="st">"sessions"</span><span class="op">)</span></code></pre></div>
<p>When requesting multiple date ranges, you can use a new ordering feature of v4 to find the 10 most changed dimensions, rather than just say the top 10. <a href="http://code.markedmondson.me/quicker-insight-sort-metric-delta/">An article about using this feature can be found here</a>.</p>
<p>An example is shown below, using the <code>order_type</code> function to sort by the change (<code>DELTA</code>) between dates:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delta_sess</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/order_type.html">order_type</a></span><span class="op">(</span><span class="st">"sessions"</span>,<span class="st">"DESCENDING"</span>, <span class="st">"DELTA"</span><span class="op">)</span>

<span class="co">## find top 20 landing pages that changed most in sessions comparing this week and last week</span>
<span class="va">gadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">gaid</span>,
                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"16daysAgo"</span>, <span class="st">"9daysAgo"</span>, <span class="st">"8daysAgo"</span>, <span class="st">"yesterday"</span><span class="op">)</span>,
                             metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sessions"</span><span class="op">)</span>,
                             dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"landingPagePath"</span><span class="op">)</span>,
                             order <span class="op">=</span> <span class="va">delta_sess</span>,
                             max <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="anti-sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#anti-sampling" class="anchor"></a>Anti-sampling</h2>
<p>Anti-sampling is a common use case for using the API.</p>
<p>Sampling is due to your API request being over the session limits <a href="https://support.google.com/analytics/answer/2637192">outlined in this Google article</a>. This limit is higher for Google Analytics 360.</p>
<p>If you split up your API request so that the number of sessions falls under these limits, sampling will not occur.</p>
<div id="sampled-data-example" class="section level3">
<h3 class="hasAnchor">
<a href="#sampled-data-example" class="anchor"></a>Sampled data example</h3>
<p>If you have sampling in your data request, <code>googleAnalyticsR</code> reports it back to you in the console when making the request.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleAnalyticsR/">googleAnalyticsR</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/ga_auth.html">ga_auth</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">sampled_data_fetch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">id</span>, 
                                         date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-01-01"</span>,<span class="st">"2015-06-21"</span><span class="op">)</span>, 
                                         metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"users"</span>,<span class="st">"sessions"</span>,<span class="st">"bounceRate"</span><span class="op">)</span>, 
                                         dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"landingPagePath"</span>,<span class="st">"source"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#Calling APIv4....</span>
<span class="co">#Data is sampled, based on 39.75% of visits.</span></code></pre></div>
</div>
<div id="unsampled-data-example" class="section level3">
<h3 class="hasAnchor">
<a href="#unsampled-data-example" class="anchor"></a>Unsampled data example</h3>
<p>Setting the argument <code>anti_sample=TRUE</code> in a <code><a href="../reference/google_analytics.html">google_analytics()</a></code> request causes the calls to be split up into small enough chunks to avoid sampling. This uses more API calls so the data will reach you slower, but it should hold more detail.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleAnalyticsR/">googleAnalyticsR</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/ga_auth.html">ga_auth</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">unsampled_data_fetch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">id</span>, 
                                         date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-01-01"</span>,<span class="st">"2015-06-21"</span><span class="op">)</span>, 
                                         metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"users"</span>,<span class="st">"sessions"</span>,<span class="st">"bounceRate"</span><span class="op">)</span>, 
                                         dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"landingPagePath"</span>,<span class="st">"source"</span><span class="op">)</span>,
                                         anti_sample <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">#anti_sample set to TRUE. Mitigating sampling via multiple API calls.</span>
<span class="co">#Finding how much sampling in data request...</span>
<span class="co">#Data is sampled, based on 39.75% of visits.</span>
<span class="co">#Downloaded [10] rows from a total of [59235].</span>
<span class="co">#Finding number of sessions for anti-sample calculations...</span>
<span class="co">#Downloaded [172] rows from a total of [172].</span>
<span class="co">#Calculated [3] batches are needed to download [59235] rows unsampled.</span>
<span class="co">#Anti-sample call covering 128 days: 2015-01-01, 2015-05-08</span>
<span class="co">#Downloaded [59235] rows from a total of [59235].</span>
<span class="co">#Anti-sample call covering 23 days: 2015-05-09, 2015-05-31</span>
<span class="co">#Downloaded [20239] rows from a total of [20239].</span>
<span class="co">#Anti-sample call covering 21 days: 2015-06-01, 2015-06-21</span>
<span class="co">#Downloaded [21340] rows from a total of [21340].</span>
<span class="co">#Finished unsampled data request, total rows [100814]</span>
<span class="co">#Successfully avoided sampling</span></code></pre></div>
<p>The sequence involves a couple of exploratory API calls to determine the best split. This method will adjust the time periods to have the batch sizes large enough to not take too long, but small enough to have unsampled data.</p>
</div>
<div id="auto-anti-sampling-failure" class="section level3">
<h3 class="hasAnchor">
<a href="#auto-anti-sampling-failure" class="anchor"></a>Auto-anti sampling failure</h3>
<p>In some cases the anti-sampling won’t work. This will mainly be due to filters for the View you are using meaning that the calculation for the sampling sessions are incorrect - Google Analytics vanilla samples on a property level (whilst GA360 samples on a View level).</p>
<p>Try using a raw profile if you can, otherwise you can set your own sample period by using the <code>anti_sample_batches</code> flag to indicate the sample size. Pick a number that is a little lower than the smallest period you saw in the auto-sample batches. If in doubt, setting <code>anti_sample_batches</code> to 1 will make a daily fetch.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## example setting your own anti_sample_batch to 5 days per batch</span>
<span class="va">unsampled_data_fetch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">id</span>, 
                                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-01-01"</span>,<span class="st">"2015-06-21"</span><span class="op">)</span>, 
                                             metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"users"</span>,<span class="st">"sessions"</span>,<span class="st">"bounceRate"</span><span class="op">)</span>, 
                                             dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"landingPagePath"</span>,<span class="st">"source"</span><span class="op">)</span>,
                                             anti_sample <span class="op">=</span> <span class="cn">TRUE</span>,
                                             anti_sample_batch <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="filters" class="section level2">
<h2 class="hasAnchor">
<a href="#filters" class="anchor"></a>Filters</h2>
<blockquote>
<p>Note these are different from account filters, which you can manipulate using the management API using the <code>ga_filter</code> family of functions. See the <a href="http://code.markedmondson.me/googleAnalyticsR/management.html">Management API</a></p>
</blockquote>
<p>Filters need to be built up from the <code>met_filter</code> and <code>dim_filter</code> R objects.</p>
<p>These then need to be wrapped in <code>filter_clause_ga4</code> function, which lets you specify the combination rules (<code>AND</code> or <code>OR</code>). The <code>met_filter</code> and <code>dim_filter</code> you pass in should be wrapped in a <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> - see examples:</p>
<div id="one-filter" class="section level3">
<h3 class="hasAnchor">
<a href="#one-filter" class="anchor"></a>One filter</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">campaign_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim_filter.html">dim_filter</a></span><span class="op">(</span>dimension<span class="op">=</span><span class="st">"campaign"</span>,operator<span class="op">=</span><span class="st">"REGEXP"</span>,expressions<span class="op">=</span><span class="st">"welcome"</span><span class="op">)</span>

<span class="va">my_filter_clause</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_clause_ga4.html">filter_clause_ga4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">campaign_filter</span><span class="op">)</span><span class="op">)</span>

<span class="va">data_fetch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>,date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-01-01"</span>,<span class="st">"2016-12-31"</span><span class="op">)</span>,
                                 metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"itemRevenue"</span>,<span class="st">"itemQuantity"</span><span class="op">)</span>,
                                 dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"campaign"</span>,<span class="st">"transactionId"</span>,<span class="st">"dateHour"</span><span class="op">)</span>,
                                 dim_filters <span class="op">=</span> <span class="va">my_filter_clause</span>,
                                 anti_sample <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="multiple-filters" class="section level3">
<h3 class="hasAnchor">
<a href="#multiple-filters" class="anchor"></a>Multiple filters</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create filters on metrics</span>
<span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/met_filter.html">met_filter</a></span><span class="op">(</span><span class="st">"bounces"</span>, <span class="st">"GREATER_THAN"</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">mf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/met_filter.html">met_filter</a></span><span class="op">(</span><span class="st">"sessions"</span>, <span class="st">"GREATER"</span>, <span class="fl">2</span><span class="op">)</span>

<span class="co">## create filters on dimensions</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim_filter.html">dim_filter</a></span><span class="op">(</span><span class="st">"source"</span>,<span class="st">"BEGINS_WITH"</span>,<span class="st">"1"</span>,not <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim_filter.html">dim_filter</a></span><span class="op">(</span><span class="st">"source"</span>,<span class="st">"BEGINS_WITH"</span>,<span class="st">"a"</span>,not <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## construct filter objects</span>
<span class="va">fc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_clause_ga4.html">filter_clause_ga4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df2</span><span class="op">)</span>, operator <span class="op">=</span> <span class="st">"AND"</span><span class="op">)</span>
<span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_clause_ga4.html">filter_clause_ga4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mf</span>, <span class="va">mf2</span><span class="op">)</span>, operator <span class="op">=</span> <span class="st">"AND"</span><span class="op">)</span>

<span class="co">## make v4 request</span>
<span class="va">ga_data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                              date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span><span class="op">)</span>,
                              dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span><span class="op">)</span>, 
                              metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>, 
                              met_filters <span class="op">=</span> <span class="va">fc</span>, 
                              dim_filters <span class="op">=</span> <span class="va">fc2</span>, 
                              filtersExpression <span class="op">=</span> <span class="st">"ga:source!=(direct)"</span><span class="op">)</span>

<span class="va">ga_data1</span>

<span class="co">#                     source   medium sessions bounces</span>
<span class="co"># 1                  baby.dk referral        3       2</span>
<span class="co"># 2                     bing  organic       71      42</span>
<span class="co"># 3  buttons-for-website.com referral        7       7</span>
<span class="co"># 4           duckduckgo.com referral        5       3</span>
<span class="co"># 5                   google  organic      642     520</span>
<span class="co"># 6                google.se referral        3       2</span>
<span class="co"># 7                 izito.se referral        3       1</span>
<span class="co"># 8          success-seo.com referral       35      35</span>
<span class="co"># 9    video--production.com referral       11      11</span>
<span class="co"># 10                   yahoo  organic       66      43</span>
<span class="co"># 11              zapmeta.se referral        6       4</span></code></pre></div>
</div>
</div>
<div id="multiple-reports" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-reports" class="anchor"></a>Multiple reports</h2>
<p>Using v4’s batching ability, you can send in multiple types of API requests at the same time (up to 5). The reports need to be for the same ViewID and date range.</p>
<p>To use, you need to create your API requests first using <code>make_ga_4_req()</code>, then make the actual call using <code>fetch_google_analytics()</code>. For the common use case of only requesting one type of request, this is what <code><a href="../reference/google_analytics.html">google_analytics()</a></code> is doing behind the scenes.</p>
<div id="demo-of-querying-two-api-requests" class="section level3">
<h3 class="hasAnchor">
<a href="#demo-of-querying-two-api-requests" class="anchor"></a>Demo of querying two API requests</h3>
<p>The below example requests with two date ranges and two reports.</p>
<p>When fetching multiple reports, you need to wrap the <code>make_ga_4_req()</code> created objects in a <code><a href="https://rdrr.io/r/base/list.html">list()</a></code></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## First request we make via make_ga_4_req()</span>
<span class="va">multidate_test</span> <span class="op">&lt;-</span> <span class="fu">make_ga_4_req</span><span class="op">(</span><span class="va">ga_id</span>, 
                                date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,
                                               <span class="st">"2015-10-01"</span>,
                                               <span class="st">"2014-07-30"</span>,
                                               <span class="st">"2014-10-01"</span><span class="op">)</span>,
                                dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span><span class="op">)</span>, 
                                metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>,
                                order <span class="op">=</span> <span class="fu"><a href="../reference/order_type.html">order_type</a></span><span class="op">(</span><span class="st">"sessions"</span>, <span class="st">"DESCENDING"</span>, <span class="st">"DELTA"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Second request - same date ranges and ID required, but different dimensions/metrics/order.</span>
<span class="va">multi_test2</span> <span class="op">&lt;-</span> <span class="fu">make_ga_4_req</span><span class="op">(</span><span class="va">ga_id</span>,
                                date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,
                                               <span class="st">"2015-10-01"</span>,
                                               <span class="st">"2014-07-30"</span>,
                                               <span class="st">"2014-10-01"</span><span class="op">)</span>,
                             dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'hour'</span>,<span class="st">'medium'</span><span class="op">)</span>, 
                             metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'visitors'</span>,<span class="st">'bounces'</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Request the two calls by wrapping them in a list() and passing to fetch_google_analytics()</span>
<span class="va">ga_data3</span> <span class="op">&lt;-</span> <span class="fu">fetch_google_analytics</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">multidate_test</span>, <span class="va">multi_test2</span><span class="op">)</span><span class="op">)</span> 
<span class="va">ga_data3</span>
<span class="co"># [[1]]</span>
<span class="co">#                     source   medium sessions.d1 bounces.d1 sessions.d2 bounces.d2</span>
<span class="co"># 1                  baby.dk referral           3          2           6          3</span>
<span class="co"># 2                     bing  organic          71         42         217        126</span>
<span class="co"># 3  buttons-for-website.com referral           7          7           0          0</span>
<span class="co"># 4           duckduckgo.com referral           5          3           0          0</span>
<span class="co"># 5                   google  organic         642        520        1286        920</span>
<span class="co"># 6                google.se referral           3          2          12          9</span>
<span class="co"># 7                 izito.se referral           3          1           0          0</span>
<span class="co"># 8          success-seo.com referral          35         35           0          0</span>
<span class="co"># 9    video--production.com referral          11         11           0          0</span>
<span class="co"># 10                   yahoo  organic          66         43         236        178</span>
<span class="co"># 11              zapmeta.se referral           6          4           9          4</span>
<span class="co"># </span>
<span class="co"># [[2]]</span>
<span class="co">#    hour   medium visitors.d1 bounces.d1 visitors.d2 bounces.d2</span>
<span class="co"># 1    00  organic          28         16          85         59</span>
<span class="co"># 2    00 referral           3          2           1          1</span>
<span class="co"># 3    01  organic          43         28          93         66</span>
</code></pre></div>
</div>
</div>
<div id="metric-expressions" class="section level2">
<h2 class="hasAnchor">
<a href="#metric-expressions" class="anchor"></a>Metric expressions</h2>
<p>Metric expressions are custom calculated metrics that can be calculated on the fly when you supply a named vector with the name of your created custom metric, and the calculation expression you are performing. These are different from the calculated metrics you can create in the web UI.</p>
<blockquote>
<p>You need to use the <code>ga:</code> prefix when creating custom metrics, unlike normal API requests</p>
</blockquote>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_custom_metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>visitPerVisitor <span class="op">=</span> <span class="st">"ga:visits/ga:visitors"</span><span class="op">)</span></code></pre></div>
<p>Use metric expressions as you would other metrics within the <code>metrics</code> argument, but you also need to supply a <code>metricFormat</code> (see <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/rest/v4/reports/batchGet#MetricType">docs</a>) vector the same length which specifies the type of the metric you have calculated. These can be:</p>
<ul>
<li><code>METRIC_TYPE_UNSPECIFIED</code></li>
<li><code>INTEGER</code></li>
<li><code>FLOAT</code></li>
<li>
<code>CURRENCY</code><br>
</li>
<li><code>PERCENT</code></li>
<li><code>TIME</code></li>
</ul>
<p>An example is shown below, where a calculated metric is combined with a normal metric, <code>bounces</code>, which is type integer. You can lookup what the default metrics types are in the <code>meta</code> lookup table.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_custom_metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>visitPerVisitor <span class="op">=</span> <span class="st">"ga:visits/ga:visitors"</span><span class="op">)</span>
<span class="va">ga_data4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>,
                               date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,
                                              <span class="st">"2015-10-01"</span><span class="op">)</span>,
                              dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'medium'</span><span class="op">)</span>, 
                              metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">my_custom_metric</span>,
                                          <span class="st">'bounces'</span><span class="op">)</span>, 
                              metricFormat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FLOAT"</span>,<span class="st">"INTEGER"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ga_data4</span>
<span class="co">#     medium visitsPerVisitor bounces</span>
<span class="co"># 1   (none)         1.000000     117</span>
<span class="co"># 2  organic         1.075137     612</span>
<span class="co"># 3 referral         1.012500      71</span></code></pre></div>
</div>
<div id="segments-v4" class="section level2">
<h2 class="hasAnchor">
<a href="#segments-v4" class="anchor"></a>Segments v4</h2>
<p>Segments are more complex to configure that v3, but more powerful and in line to how you configure them in the UI.</p>
<p>A lot of feedback is about how to get the sample syntax right, so the examples below try to cover common scenarios.</p>
<div id="v3-segments" class="section level3">
<h3 class="hasAnchor">
<a href="#v3-segments" class="anchor"></a>v3 segments</h3>
<p>You can choose to create segments via the v4 syntax or the v3 syntax for backward compatibility.</p>
<p>If you want to use v3 segments, then they can be used in the <code>segment_id</code> argument of the <code><a href="../reference/segment_ga4.html">segment_ga4()</a></code> function.</p>
<p>You can view the segment Ids by using <code><a href="../reference/ga_segment_list.html">ga_segment_list()</a></code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">## get list of segments</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>segs &lt;-<span class="st"> </span><span class="kw">ga_segment_list</span>()</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">## segment Ids and name:</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>segs[,<span class="kw">c</span>(<span class="st">"name"</span>,<span class="st">"id"</span>,<span class="st">"definition"</span>)]</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">## example output</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  id            name                                                          definition</span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="dv">1</span> <span class="dv">-1</span>       All Users                                                                    </span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="dv">2</span> <span class="dv">-2</span>       New Users                       sessions<span class="op">::</span>condition<span class="op">::</span>ga<span class="op">:</span>userType<span class="op">==</span>New Visitor</span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="dv">3</span> <span class="dv">-3</span> Returning Users                 sessions<span class="op">::</span>condition<span class="op">::</span>ga<span class="op">:</span>userType<span class="op">==</span>Returning Visitor</span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="dv">4</span> <span class="dv">-4</span>    Paid Traffic         sessions<span class="op">::</span>condition<span class="op">::</span>ga<span class="op">:</span>medium=<span class="er">~^</span>(cpc<span class="op">|</span>ppc<span class="op">|</span>cpa<span class="op">|</span>cpm<span class="op">|</span>cpv<span class="op">|</span>cpp)<span class="op">$</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="dv">5</span> <span class="dv">-5</span> Organic Traffic                             sessions<span class="op">::</span>condition<span class="op">::</span>ga<span class="op">:</span>medium<span class="op">==</span>organic</span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="dv">6</span> <span class="dv">-6</span>  Search Traffic sessions<span class="op">::</span>condition<span class="op">::</span>ga<span class="op">:</span>medium=<span class="er">~^</span>(cpc<span class="op">|</span>ppc<span class="op">|</span>cpa<span class="op">|</span>cpm<span class="op">|</span>cpv<span class="op">|</span>cpp<span class="op">|</span>organic)<span class="op">$</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>....</span></code></pre></div>
<p>The ID you require is in the <code>$id</code> column which you need to prefix with “gaid::”</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## choose the v3 segment</span>
<span class="va">segment_for_call</span> <span class="op">&lt;-</span> <span class="st">"gaid::-4"</span>

<span class="co">## make the v3 segment object in the v4 segment object:</span>
<span class="va">seg_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"PaidTraffic"</span>, segment_id <span class="op">=</span> <span class="va">segment_for_call</span><span class="op">)</span>

<span class="co">## make the segment call</span>
<span class="va">segmented_ga1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span><span class="op">)</span>, 
                                    dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span><span class="op">)</span>, 
                                    segments <span class="op">=</span> <span class="va">seg_obj</span>, 
                                    metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>
                                    <span class="op">)</span>
  </code></pre></div>
<p>…or you can pass the v3 syntax for dynamic segments found from the <code>$definition</code> column:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## or pass the segment v3 defintion in directly:</span>
<span class="va">segment_def_for_call</span> <span class="op">&lt;-</span> <span class="st">"sessions::condition::ga:medium=~^(cpc|ppc|cpa|cpm|cpv|cpp)$"</span>

<span class="co">## make the v3 segment object in the v4 segment object:</span>
<span class="va">seg_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"PaidTraffic"</span>, segment_id <span class="op">=</span> <span class="va">segment_def_for_call</span><span class="op">)</span>

<span class="co">## make the segment call</span>
<span class="va">segmented_ga1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span><span class="op">)</span>, 
                                    dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span><span class="op">)</span>, 
                                    segments <span class="op">=</span> <span class="va">seg_obj</span>, 
                                    metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>
                                    <span class="op">)</span></code></pre></div>
</div>
<div id="v4-segment-syntax" class="section level3">
<h3 class="hasAnchor">
<a href="#v4-segment-syntax" class="anchor"></a>v4 segment syntax</h3>
<p>Its recommended you embrace the new v4 syntax, as its more flexible and powerful in the long run.</p>
<p>The hierarachy of the segment elements you will need are:</p>
<ul>
<li>
<em><code><a href="../reference/segment_ga4.html">segment_ga4()</a></code></em> - this is the top of the segment tree. You can pass one or a list of these into a <code><a href="../reference/google_analytics.html">google_analytics()</a></code> segment argument. Here you name the segment as it will appear in the <code>segment</code> dimension, and pass in segment definitions either via an existing segmentID or v3 definition; via a user scoped level; or via a session scoped level. The user and session scopes can have one or a list of <code><a href="../reference/segment_define.html">segment_define()</a></code> functions.</li>
<li>
<em><code><a href="../reference/segment_define.html">segment_define()</a></code></em> - this is where you define the types of segment filters that you are passing in - they are combined in a logical AND. The segment filters can be of a <code>segment_vector_simple</code> type (where order doesn’t matter) or a <code>segment_vector_sequence</code> type (where order does matter.) You can also pass in a <code>not_vector</code> of the same length as the list of segment filters, which dictates if the segments you pass in are included (the default) or excluded.</li>
<li>
<em><code><a href="../reference/segment_vector_simple.html">segment_vector_simple()</a></code></em> and <em><code><a href="../reference/segment_vector_sequence.html">segment_vector_sequence()</a></code></em> - these are vectors of <code>segment_element</code>, and determine if the conditions are included in a logical OR fashion, or if the sequence of steps is important (for instance users who saw this page, then that page.)<br>
</li>
<li>
<em><code>segment_element</code></em> - this is the lowest atom of segments, and lets you define on which metric or dimension you are segmenting on. You pass one or a list of these to <em><code><a href="../reference/segment_vector_simple.html">segment_vector_simple()</a></code></em> or <em><code><a href="../reference/segment_vector_sequence.html">segment_vector_sequence()</a></code></em>
</li>
</ul>
</div>
<div id="demo-simple-segment" class="section level3">
<h3 class="hasAnchor">
<a href="#demo-simple-segment" class="anchor"></a>Demo: simple segment</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"sessions"</span>, 
                      operator <span class="op">=</span> <span class="st">"GREATER_THAN"</span>, 
                      type <span class="op">=</span> <span class="st">"METRIC"</span>, 
                      comparisonValue <span class="op">=</span> <span class="fl">1</span>, 
                      scope <span class="op">=</span> <span class="st">"USER"</span><span class="op">)</span>
                      
<span class="va">se2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"medium"</span>, 
                      operator <span class="op">=</span> <span class="st">"EXACT"</span>, 
                      type <span class="op">=</span> <span class="st">"DIMENSION"</span>, 
                      expressions <span class="op">=</span> <span class="st">"organic"</span><span class="op">)</span>

<span class="co">## choose between segment_vector_simple or segment_vector_sequence</span>
<span class="co">## Elements can be combined into clauses, which can then be combined into OR filter clauses</span>
<span class="va">sv_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_vector_simple.html">segment_vector_simple</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">sv_simple2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_vector_simple.html">segment_vector_simple</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">se2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Each segment vector can then be combined into a logical AND</span>
<span class="va">seg_defined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_define.html">segment_define</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">sv_simple</span>, <span class="va">sv_simple2</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Each segement defintion can apply to users, sessions or both.</span>
<span class="co">## You can pass a list of several segments</span>
<span class="va">segment4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"simple"</span>, user_segment <span class="op">=</span> <span class="va">seg_defined</span><span class="op">)</span>

<span class="co">## Add the segments to the segments param</span>
<span class="va">segment_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                                      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span><span class="op">)</span>, 
                                      dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span><span class="op">)</span>, 
                                      segments <span class="op">=</span> <span class="va">segment4</span>, 
                                      metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>
                                      <span class="op">)</span>

<span class="va">segment_example</span>
<span class="co">#                            source   medium segment sessions bounces</span>
<span class="co"># 1                        24.co.uk referral  simple        1       1</span>
<span class="co"># 2                     aidsmap.com referral  simple        1       0</span>
<span class="co"># 3                             aol  organic  simple       30      19</span>
<span class="co"># 4                             ask  organic  simple       32      17</span>

<span class="co">## You can send in multiple segments at a time by adding them as a list</span>
<span class="va">segment4_again</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"simple_2"</span>, user_segment <span class="op">=</span> <span class="va">seg_defined</span><span class="op">)</span>

<span class="co">## Add the segments to the segments param</span>
<span class="va">segment_example2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                                      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2015-07-30"</span>,<span class="st">"2015-10-01"</span><span class="op">)</span>, 
                                      dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span>,<span class="st">'medium'</span>,<span class="st">'segment'</span><span class="op">)</span>, 
                                      segments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">segment4</span>, <span class="va">segment4_again</span><span class="op">)</span>,
                                      metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span>,<span class="st">'bounces'</span><span class="op">)</span>
                                      <span class="op">)</span>
<span class="co">#                source   medium  segment sessions bounces</span>
<span class="co">#1             (direct)   (none)   simple       30      22</span>
<span class="co">#2             (direct)   (none) simple_2       30      22</span>
<span class="co">#3       127.0.0.1:7424 referral   simple        1       1</span>
<span class="co">#4       127.0.0.1:7424 referral simple_2        1       1</span>
<span class="co">#5  analyticsforfun.com referral   simple        5       1</span>
<span class="co">#6  analyticsforfun.com referral simple_2        5       1</span>
<span class="co">#...</span></code></pre></div>
</div>
<div id="demo-sequence-segment" class="section level3">
<h3 class="hasAnchor">
<a href="#demo-sequence-segment" class="anchor"></a>Demo: Sequence segment</h3>
<pre><code>se2 &lt;- segment_element("medium", 
                       operator = "EXACT", 
                       type = "DIMENSION", 
                       expressions = "organic")
  
se3 &lt;- segment_element("medium",
                       operator = "EXACT",
                       type = "DIMENSION",
                       not = TRUE,
                       expressions = "organic")
  
## step sequence
## users who arrived via organic then via referral
sv_sequence &lt;- segment_vector_sequence(list(list(se2), 
                                              list(se3)))
  
seq_defined2 &lt;- segment_define(list(sv_sequence))
  
segment4_seq &lt;- segment_ga4("sequence", user_segment = seq_defined2)
  
## Add the segments to the segments param
segment_seq_example &lt;- google_analytics(ga_id, 
                                        c("2016-01-01","2016-03-01"), 
                                        dimensions=c('source','segment'), 
                                        segments = segment4_seq,
                                        metrics = c('sessions','bounces')
                                        )
  
segment_seq_example
#                                source  segment sessions bounces
# 1                                 aol sequence        1       0
# 2                                 ask sequence        5       1
# 3      bestbackpackersinsurance.co.uk sequence        9       6
# 4                                bing sequence       22       2</code></pre>
<p>Some more examples, using different match types, contributed by Pawel Kapuscinski:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">con1</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/segment_vector_simple.html">segment_vector_simple</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"ga:dimension1"</span>, 
                      operator <span class="op">=</span> <span class="st">"REGEXP"</span>, 
                      type <span class="op">=</span> <span class="st">"DIMENSION"</span>, 
                      expressions <span class="op">=</span> <span class="st">".*"</span>, 
                      scope <span class="op">=</span> <span class="st">"SESSION"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">con2</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/segment_vector_simple.html">segment_vector_simple</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"ga:deviceCategory"</span>, 
                      operator <span class="op">=</span> <span class="st">"EXACT"</span>, 
                      type <span class="op">=</span> <span class="st">"DIMENSION"</span>, 
                      expressions <span class="op">=</span> <span class="st">"Desktop"</span>, 
                      scope <span class="op">=</span> <span class="st">"SESSION"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">seq1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"ga:pagePath"</span>, 
                         operator <span class="op">=</span> <span class="st">"EXACT"</span>, 
                         type <span class="op">=</span> <span class="st">"DIMENSION"</span>, 
                         expressions <span class="op">=</span> <span class="st">"yourdomain.com/page-path"</span>, 
                         scope <span class="op">=</span> <span class="st">"SESSION"</span><span class="op">)</span>


<span class="va">seq2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"ga:eventAction"</span>, 
                         operator <span class="op">=</span> <span class="st">"REGEXP"</span>, 
                         type <span class="op">=</span> <span class="st">"DIMENSION"</span>, 
                         expressions <span class="op">=</span> <span class="st">"english"</span>, 
                         scope <span class="op">=</span> <span class="st">"SESSION"</span>,
                         matchType <span class="op">=</span> <span class="st">"IMMEDIATELY_PRECEDES"</span><span class="op">)</span>

<span class="va">allSEQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_vector_sequence.html">segment_vector_sequence</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">seq1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">seq2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                             date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-08-08"</span>,<span class="st">"2016-09-08"</span><span class="op">)</span>,
                             segments <span class="op">=</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"sequence+condition"</span>,
                                                    user_segment <span class="op">=</span> <span class="fu"><a href="../reference/segment_define.html">segment_define</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">con1</span>,<span class="va">con2</span>,<span class="va">allSEQ</span><span class="op">)</span><span class="op">)</span>
                                                    <span class="op">)</span>,
                             metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ga:users'</span><span class="op">)</span>,
                             dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ga:segment'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Users whose first session to website was social:</span>
<span class="va">seg_social</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"channelGrouping"</span>,
                              operator <span class="op">=</span> <span class="st">"EXACT"</span>,
                              type <span class="op">=</span> <span class="st">"DIMENSION"</span>,
                              expressions <span class="op">=</span> <span class="st">"Social"</span><span class="op">)</span>
<span class="va">seg_first_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_element.html">segment_element</a></span><span class="op">(</span><span class="st">"sessionCount"</span>,
                                   operator <span class="op">=</span> <span class="st">"EXACT"</span>,
                                   type <span class="op">=</span> <span class="st">"DIMENSION"</span>,
                                   expressions <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>
<span class="co"># social referrral followed by first sessionCount</span>
<span class="va">segment_social_first</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_vector_sequence.html">segment_vector_sequence</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">seg_social</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">seg_first_visit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">sd_segment</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_define.html">segment_define</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">segment_social_first</span><span class="op">)</span><span class="op">)</span>
<span class="va">segment_social</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/segment_ga4.html">segment_ga4</a></span><span class="op">(</span><span class="st">"social_first"</span>, user_segment <span class="op">=</span> <span class="va">sd_segment</span><span class="op">)</span>
<span class="va">segment_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics_4</a></span><span class="op">(</span><span class="va">my_viewId</span>,
                                   date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"8daysAgo"</span>, <span class="st">"yesterday"</span><span class="op">)</span>,
                                   metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sessions"</span>, <span class="st">"users"</span>, sessions_per_user <span class="op">=</span> <span class="st">"ga:sessions/ga:users"</span><span class="op">)</span>,
                                   dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"country"</span>, <span class="st">"channelGrouping"</span>, <span class="st">"sessionCount"</span><span class="op">)</span>,
                                   segments <span class="op">=</span> <span class="va">segment_social</span>,
                                   metricFormat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FLOAT"</span>, <span class="st">"INTEGER"</span>, <span class="st">"INTEGER"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If you are still struggling with segment syntax, you may want to try the <a href="https://github.com/jdeboer/ganalytics/issues/56"><code>ganalytics</code> package</a> by Johann de Boer which has developed a domain specific language for making segments and may be easier to parse.</p>
</div>
<div id="rstudio-addin-segment-helper" class="section level3">
<h3 class="hasAnchor">
<a href="#rstudio-addin-segment-helper" class="anchor"></a>RStudio Addin: Segment helper</h3>
<p>There is an RStudio Addin to help create segments via a UI rather than the lists above.</p>
<p>You can call it via <code>googleAnalyticsR:::gadget_GASegment()</code> or within the RStudio interface like displayed below:</p>
<div class="figure">
<img src="googleAnalyticsRsegmentCreator.gif" alt=""><p class="caption">Google Analytics v4 segment RStudio Addin</p>
</div>
</div>
</div>
<div id="cohort-reports" class="section level2">
<h2 class="hasAnchor">
<a href="#cohort-reports" class="anchor"></a>Cohort reports</h2>
<p>Details on <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/advanced#cohorts">cohort reports and LTV can be found here</a> and via the examples below.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## first make a cohort group</span>
<span class="va">cohort4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_cohort_group.html">make_cohort_group</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Jan2016"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-01-01"</span>, <span class="st">"2016-01-31"</span><span class="op">)</span>, 
                                <span class="st">"Feb2016"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-02-01"</span>,<span class="st">"2016-02-28"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## then call cohort report.  No date_range and must include metrics and dimensions</span>
<span class="co">##   from the cohort list</span>
<span class="va">cohort_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                                     dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cohort'</span><span class="op">)</span>, 
                                     cohort <span class="op">=</span> <span class="va">cohort4</span>, 
                                     metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cohortTotalUsers'</span><span class="op">)</span><span class="op">)</span>

<span class="va">cohort_example</span>
<span class="co">#    cohort cohortTotalUsers</span>
<span class="co"># 1 Feb2016            19040</span>
<span class="co"># 2 Jan2016            23378</span></code></pre></div>
</div>
<div id="pivot-requests" class="section level2">
<h2 class="hasAnchor">
<a href="#pivot-requests" class="anchor"></a>Pivot Requests</h2>
<p>These change the shape of the returned data, which you could probably do in R anyway but it gives you another option when you make the request.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## filter pivot results to </span>
<span class="va">pivot_dim_filter1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim_filter.html">dim_filter</a></span><span class="op">(</span><span class="st">"medium"</span>,
                                <span class="st">"REGEXP"</span>,
                                <span class="st">"organic|social|email|cpc"</span><span class="op">)</span>
                                
<span class="va">pivot_dim_clause</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_clause_ga4.html">filter_clause_ga4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">pivot_dim_filter1</span><span class="op">)</span><span class="op">)</span>

<span class="va">pivme</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pivot_ga4.html">pivot_ga4</a></span><span class="op">(</span><span class="st">"medium"</span>,
                   metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sessions"</span><span class="op">)</span>, 
                   maxGroupCount <span class="op">=</span> <span class="fl">4</span>, 
                   dim_filter_clause <span class="op">=</span> <span class="va">pivot_dim_clause</span><span class="op">)</span>

<span class="va">pivtest1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                               <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-01-30"</span>,<span class="st">"2016-10-01"</span><span class="op">)</span>, 
                               dimensions<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'source'</span><span class="op">)</span>, 
                               metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sessions'</span><span class="op">)</span>, 
                               pivots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">pivme</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">pivtest1</span><span class="op">)</span>
<span class="co">#  [1] "source"                      "sessions"                    "medium.referral.sessions"   </span>
<span class="co">#  [4] "medium..none..sessions"      "medium.cpc.sessions"         "medium.email.sessions"      </span>
<span class="co">#  [7] "medium.social.sessions"      "medium.twitter.sessions"     "medium.socialMedia.sessions"</span>
<span class="co"># [10] "medium.Social.sessions"      "medium.linkedin.sessions"  </span></code></pre></div>
</div>
<div id="ga360-quota-system" class="section level2">
<h2 class="hasAnchor">
<a href="#ga360-quota-system" class="anchor"></a>GA360 Quota System</h2>
<p>If you have GA360, you have access to <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/resource-based-quota">resource based quotas</a> that increase the number of sessions before sampling kicks in from 1 to 100 million sessions.</p>
<p>To access this quota, set <code>useResourceQuotas = TRUE</code> in the command.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span>,
                 max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
                 useResourceQuotas <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="customising-api-fetches" class="section level2">
<h2 class="hasAnchor">
<a href="#customising-api-fetches" class="anchor"></a>Customising API fetches</h2>
<p><code>googleAnalyticsR</code> has some techniques implemented to get the data as quickly as possible. This includes:</p>
<div id="batching-large-results" class="section level3">
<h3 class="hasAnchor">
<a href="#batching-large-results" class="anchor"></a>Batching large results</h3>
<p>The v4 API allows you to send 5 batched calls at once in one API request, meaning by default 50,000 rows will be requested per API call. However, since this puts additional strain on the Google servers, for complicated queries (i.e. lots of segments or dimensions) this may fail with a 500 error. If that happens, the library will fall back to the slower fetching of 10,000 rows per API call.</p>
<p>If you want to default to the slower fetching, set <code>slow_fetch=TRUE</code> in your request e.g.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span>,
                 max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
                 slow_fetch <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="caching" class="section level3">
<h3 class="hasAnchor">
<a href="#caching" class="anchor"></a>Caching</h3>
<p>Local caching is enabled that will mean if you make the exact same API request with all arguments the same, the result will come from memory rather than the API. By default this is within the RAM of the same R session so will reset when you restart R, but if you want you can set this to save the cache to disk using the <code><a href="../reference/ga_cache_call.html">ga_cache_call()</a></code> function. Use this to point to a folder to store the cache files, and the cache will then be available inbetween R sessions.</p>
<p>A demo on using caching is in the video here: <a href="https://www.youtube.com/watch?v=2-f0aTwWiNw&amp;feature=share">googleAnalyticsR - caching</a> and is embedded below:.</p>
<iframe width="560" height="315" src="http://www.youtube.com/embed/2-f0aTwWiNw?rel=0" frameborder="0" allowfullscreen>
</iframe>
<p>e.g.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ga_cache_call.html">ga_cache_call</a></span><span class="op">(</span><span class="st">"my_cache_folder"</span><span class="op">)</span>

<span class="co">## will make the call and save files to my_cache_folder</span>
<span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span>,
                 max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>
                 
<span class="co">## making the same exact call again will read from disk, and be much quicker</span>
<span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span>,
                 max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>This means that repeated long fetches can be much quicker as older requests will read from disk.</p>
<p>If you are running long repeated calls over time, this is a good strategy to only fetch the latest data from the API, relying on the cache for historic data - for instance, set a loop that requests each month’s worth of data - for the month’s you already have the requests will come from disk, but for the most recent month it will fetch from the API.</p>
</div>
<div id="rows-per-call" class="section level3">
<h3 class="hasAnchor">
<a href="#rows-per-call" class="anchor"></a>Rows Per call</h3>
<p>The API lets you call up to 100,000 rows, which coupled with the batching above means potentially 500,000 rows can be called per API call. In reality, this many rows will probably be too heavy for the Google servers, so you may want to experiment using increased row per calls but with <code>slow_fetch=TRUE</code> to find the optimum.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## making the same exact call again will read from disk, and be much quicker</span>
<span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">ga_id</span>, 
                 date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2017-03-01"</span><span class="op">)</span>, 
                 metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                 dimensions <span class="op">=</span> <span class="st">"date"</span>,
                 rows_per_call <span class="op">=</span> <span class="fl">40000</span>,
                 slow_fetch <span class="op">=</span> <span class="cn">TRUE</span>,
                 max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>The defaults are 10,000 rows per call (50,000 per batch) and <code>slow_fetch = FALSE</code> which suit for most cases.</p>
</div>
</div>
<div id="fetching-from-multiple-views" class="section level2">
<h2 class="hasAnchor">
<a href="#fetching-from-multiple-views" class="anchor"></a>Fetching from multiple views</h2>
<p>Whilst the <a href="http://code.markedmondson.me/googleAnalyticsR/v3.html">v3 multi account batching feature</a> isn’t available for multi-accounts in v4, by using <a href="https://github.com/HenrikBengtsson/future.apply"><code>future.apply</code></a> you can launch multiple R sessions that will fetch the API in parallel. An example is shown below, that fetches from three View IDs at once.</p>
<p>The limiting factor will then be the v4 <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/limits-quotas">API limits</a>, which are currently 1000 requests per 100 seconds per user, per Google API project (e.g. you will probably want to setup your own Google project if making a lot of requests)</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleAnalyticsR/">googleAnalyticsR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">future.apply</span><span class="op">)</span>

<span class="co">## setup multisession R for your parallel data fetches </span>
<span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="co">## the ViewIds to fetch all at once</span>
<span class="va">gaids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12345634</span>, <span class="fl">9888890</span>,<span class="fl">10624323</span><span class="op">)</span>

<span class="va">my_fetch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/google_analytics.html">google_analytics</a></span><span class="op">(</span><span class="va">x</span>, 
                   date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2017-01-01"</span>,<span class="st">"yesterday"</span><span class="op">)</span>, 
                   metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
                   dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"medium"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## makes 3 API calls at once</span>
<span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu">future_lapply</span><span class="op">(</span><span class="va">gaids</span>, <span class="va">my_fetch</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
